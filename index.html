<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monopoly Voice Banking - 18:9 Layout</title>
    <style>
        :root {
            --bg-color: #050505;
            --unit-bg: #151515;
            --blu: #007bff;
            --giallo: #ffcc00;
            --rosso: #ff4d4d;
            --verde: #2ecc71;
        }

        body {
            background-color: var(--bg-color);
            color: white;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
        }

        #setup-overlay {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .setup-card {
            background: #111;
            padding: 30px;
            border-radius: 30px;
            border: 1px solid #333;
            text-align: center;
            max-width: 90%;
        }

        .color-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 25px 0;
        }

        .chip {
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            border: 4px solid transparent;
            transition: 0.2s;
            text-transform: uppercase;
        }

        .chip.selected {
            border-color: white;
            transform: scale(1.05);
        }

        /* CONTENITORE CENTRALE */
        .banker-wrapper {
            position: relative;
            width: 320px;
            height: 320px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .banker-unit {
            position: relative;
            width: 220px;
            height: 220px;
            background: var(--unit-bg);
            border-radius: 50%;
            border: 8px solid #222;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 5;
            box-shadow: inset 0 0 40px #000;
            text-align: center;
            cursor: pointer;
            transition: 0.5s;
        }

        .listening-blu {
            border-color: var(--blu) !important;
            box-shadow: 0 0 50px var(--blu), inset 0 0 20px var(--blu);
        }

        .listening-giallo {
            border-color: var(--giallo) !important;
            box-shadow: 0 0 50px var(--giallo), inset 0 0 20px var(--giallo);
        }

        .listening-rosso {
            border-color: var(--rosso) !important;
            box-shadow: 0 0 50px var(--rosso), inset 0 0 20px var(--rosso);
        }

        .listening-verde {
            border-color: var(--verde) !important;
            box-shadow: 0 0 50px var(--verde), inset 0 0 20px var(--verde);
        }

        #status-text {
            color: #555;
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        #transcript {
            font-size: 0.8rem;
            font-weight: bold;
            padding: 0 15px;
            color: #fff;
            text-transform: uppercase;
        }

        /* PULSANTI GIOCATORI CON ANIMAZIONE RIPRISTINATA */
        .player-btn {
            position: absolute;
            width: 65px;
            height: 65px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10;
            border: 4px solid rgba(0, 0, 0, 0.3);
            /* L'animazione elastica */
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .btn-blu {
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--blu);
        }

        .btn-giallo {
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--giallo);
        }

        .btn-rosso {
            left: -15px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--rosso);
        }

        .btn-verde {
            right: -15px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--verde);
        }

        /* EFFETTO ZOOM QUANDO IL PULSANTE È ATTIVO */
        .player-btn.active-focus {
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) scale(1.7) !important;
            z-index: 1000 !important;
            box-shadow: 0 0 40px rgba(255, 255, 255, 0.4);
        }

        /* CHIP DEI SOLDI (SPOSTATI E RUOTATI PER 18:9) */
        .balance-card {
            position: absolute;
            background: #111;
            padding: 6px 10px;
            border-radius: 8px;
            text-align: center;
            display: none;
            border-bottom: 3px solid transparent;
            min-width: 85px;
            font-size: 0.7rem;
            z-index: 20;
        }

        .balance-card.active {
            display: block;
        }

        .money {
            display: block;
            font-weight: bold;
            color: #fff;
            margin-top: 2px;
        }

        #card-blu {
            top: -100px;
            left: 50%;
            transform: translateX(-50%) rotate(180deg);
            border-color: var(--blu);
        }

        #card-giallo {
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            border-color: var(--giallo);
        }

        /* Rosso e Verde posizionati lateralmente per schermi larghi */
        #card-rosso {
            left: -50px;
            top: 10%;
            transform: translateY(-50%) rotate(90deg);
            border-color: var(--rosso);
        }

        #card-verde {
            right: -50px;
            top: 90%;
            transform: translateY(-50%) rotate(-90deg);
            border-color: var(--verde);
        }

        .balance-card.bancarotta {
            opacity: 0.3;
            text-decoration: line-through;
        }

        #debug-console {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 20px;
            border-radius: 20px;
            z-index: 2000;
            flex-direction: column;
            gap: 10px;
        }
    </style>
</head>

<body>

    <!-- UI: SETUP INIZIALE -->
    <div id="setup-overlay">
        <div class="setup-card">
            <h1>VOICE BANKING</h1>
            <p style="color:#888">Seleziona i giocatori</p>
            <div class="color-selector">
                <div class="chip" style="background:var(--blu)" onclick="togglePlayer('blu', this)">BLU</div>
                <div class="chip" style="background:var(--giallo); color:black" onclick="togglePlayer('giallo', this)">
                    GIALLO</div>
                <div class="chip" style="background:var(--rosso)" onclick="togglePlayer('rosso', this)">ROSSO</div>
                <div class="chip" style="background:var(--verde)" onclick="togglePlayer('verde', this)">VERDE</div>
            </div>
            <button id="start-btn" onclick="startGame()">INIZIA PARTITA</button>
        </div>
    </div>

    <!-- UI: UNITÀ BANCHIERE + PULSANTI + CHIP SOLDI -->
    <div class="banker-wrapper">
        <div class="banker-unit" id="unit">
            <div id="status-text">Pronto</div>
            <div id="transcript">Tocca un colore</div>
        </div>

        <!-- Pulsanti Giocatori -->
        <div id="btn-blu" class="player-btn btn-blu" onclick="activate('blu')"></div>
        <div id="btn-giallo" class="player-btn btn-giallo" onclick="activate('giallo')"></div>
        <div id="btn-rosso" class="player-btn btn-rosso" onclick="activate('rosso')"></div>
        <div id="btn-verde" class="player-btn btn-verde" onclick="activate('verde')"></div>

        <!-- Balance Chips (Spostate e Ruotate) -->
        <div id="card-blu" class="balance-card"><span>BLU</span><span class="money" id="bal-blu">15 milioni</span></div>
        <div id="card-giallo" class="balance-card"><span>GIALLO</span><span class="money" id="bal-giallo">15
                milioni</span></div>
        <div id="card-rosso" class="balance-card"><span>ROSSO</span><span class="money" id="bal-rosso">15 milioni</span>
        </div>
        <div id="card-verde" class="balance-card"><span>VERDE</span><span class="money" id="bal-verde">15 milioni</span>
        </div>
    </div>

    <!-- UI: CONSOLE NASCOSTA -->
    <div id="debug-console">
        <div style="font-size: 0.8rem; color: #aaa; text-align:center">COMANDO TESTUALE</div>
        <input type="text" id="debug-input" placeholder="Scrivi qui...">
        <button id="debug-btn" onclick="sendManualCommand()">ESEGUI</button>
    </div>

    <script>
        // --- DATABASE DEL GIOCO (Stato di proprietà, case, affitti) ---
        let gameState = {
            players: {}, // Qui verranno salvati i saldi dei giocatori attivi
            bankruptPlayers: [], // Giocatori in bancarotta (esclusi dal gioco)
            properties: {
                "vicolo corto": { set: "marrone", price: 600000, buildCost: 500000, rents: [20000, 100000, 300000, 900000, 1600000, 2500000], owner: null, houses: 0, mortgaged: false },
                "vicolo stretto": { set: "marrone", price: 600000, buildCost: 500000, rents: [40000, 200000, 600000, 1800000, 3200000, 4500000], owner: null, houses: 0, mortgaged: false },
                "bastioni gran sasso": { set: "azzurro", price: 1000000, buildCost: 500000, rents: [60000, 300000, 900000, 2700000, 4000000, 5500000], owner: null, houses: 0, mortgaged: false },
                "viale monte rosa": { set: "azzurro", price: 1000000, buildCost: 500000, rents: [60000, 300000, 900000, 2700000, 4000000, 5500000], owner: null, houses: 0, mortgaged: false },
                "viale vesuvio": { set: "azzurro", price: 1200000, buildCost: 500000, rents: [80000, 400000, 1000000, 3000000, 4500000, 6000000], owner: null, houses: 0, mortgaged: false },
                "via accademia": { set: "rosa", price: 1400000, buildCost: 1000000, rents: [100000, 500000, 1500000, 4500000, 6250000, 7500000], owner: null, houses: 0, mortgaged: false },
                "corso ateneo": { set: "rosa", price: 1400000, buildCost: 1000000, rents: [100000, 500000, 1500000, 4500000, 6250000, 7500000], owner: null, houses: 0, mortgaged: false },
                "piazza università": { set: "rosa", price: 1600000, buildCost: 1000000, rents: [120000, 600000, 1800000, 5000000, 7000000, 9000000], owner: null, houses: 0, mortgaged: false },
                "via verdi": { set: "arancio", price: 1800000, buildCost: 1000000, rents: [140000, 700000, 2000000, 5500000, 7500000, 9500000], owner: null, houses: 0, mortgaged: false },
                "corso raffaello": { set: "arancio", price: 1800000, buildCost: 1000000, rents: [140000, 700000, 2000000, 5500000, 7500000, 9500000], owner: null, houses: 0, mortgaged: false },
                "piazza dante": { set: "arancio", price: 2000000, buildCost: 1000000, rents: [160000, 800000, 2200000, 6000000, 8000000, 10000000], owner: null, houses: 0, mortgaged: false },
                "via marco polo": { set: "rosso", price: 2200000, buildCost: 1500000, rents: [180000, 900000, 2500000, 7000000, 8750000, 10500000], owner: null, houses: 0, mortgaged: false },
                "corso magellano": { set: "rosso", price: 2200000, buildCost: 1500000, rents: [180000, 900000, 2500000, 7000000, 8750000, 10500000], owner: null, houses: 0, mortgaged: false },
                "largo colombo": { set: "rosso", price: 2400000, buildCost: 1500000, rents: [200000, 1000000, 3000000, 7500000, 9250000, 11000000], owner: null, houses: 0, mortgaged: false },
                "viale costantino": { set: "giallo", price: 2600000, buildCost: 1500000, rents: [220000, 1100000, 3300000, 8000000, 9750000, 11500000], owner: null, houses: 0, mortgaged: false },
                "viale traiano": { set: "giallo", price: 2600000, buildCost: 1500000, rents: [220000, 1100000, 3300000, 8000000, 9750000, 11500000], owner: null, houses: 0, mortgaged: false },
                "piazza giulio cesare": { set: "giallo", price: 2800000, buildCost: 1500000, rents: [240000, 1200000, 3600000, 8500000, 10250000, 12000000], owner: null, houses: 0, mortgaged: false },
                "via roma": { set: "verde", price: 3000000, buildCost: 2000000, rents: [260000, 1300000, 3900000, 9000000, 11000000, 12750000], owner: null, houses: 0, mortgaged: false },
                "corso impero": { set: "verde", price: 3000000, buildCost: 2000000, rents: [260000, 1300000, 3900000, 9000000, 11000000, 12750000], owner: null, houses: 0, mortgaged: false },
                "largo augusto": { set: "verde", price: 3200000, buildCost: 2000000, rents: [280000, 1500000, 4500000, 10000000, 12000000, 14000000], owner: null, houses: 0, mortgaged: false },
                "viale dei giardini": { set: "blu", price: 3500000, buildCost: 2000000, rents: [350000, 1750000, 5000000, 11000000, 13000000, 15000000], owner: null, houses: 0, mortgaged: false },
                "parco della vittoria": { set: "blu", price: 4000000, buildCost: 2000000, rents: [500000, 2000000, 6000000, 14000000, 17000000, 20000000], owner: null, houses: 0, mortgaged: false },
                "stazione nord": { set: "stazione", price: 2000000, owner: null, mortgaged: false },
                "stazione sud": { set: "stazione", price: 2000000, owner: null, mortgaged: false },
                "stazione est": { set: "stazione", price: 2000000, owner: null, mortgaged: false },
                "stazione ovest": { set: "stazione", price: 2000000, owner: null, mortgaged: false },
                "società elettrica": { set: "società", price: 1500000, owner: null, mortgaged: false },
                "società acqua potabile": { set: "società", price: 1500000, owner: null, mortgaged: false }
            }
        };

        // --- DATABASE CARTE IMPREVISTI (senza tracciamento carte speciali) ---
        const imprevisti = [
            {
                text: "Carta imprevisti: Andate fino al Via ed incassate 2000000!", weight: 1,
                effect: () => {
                    updateBalance(activeActor, 2000000);
                }
            },
            {
                text: "Carta imprevisti: Hai riparato le tue case: paga 600000 per ogni casa e 1200000 per ogni albergo!", weight: 1,
                effect: () => {
                    const { houses, hotels } = countPlayerBuildings(activeActor);
                    const total = houses * 600000 + hotels * 1200000;
                    updateBalance(activeActor, -total);
                }
            },
            {
                text: "Carta imprevisti: Errore della banca a tuo favore: ritira 2000000!", weight: 1,
                effect: () => {
                    updateBalance(activeActor, 2000000);
                }
            },
            {
                text: "Carta imprevisti: Fai 3 passi indietro", weight: 1,
            },
            {
                text: "Carta imprevisti: Fai 9 passi indietro", weight: 1,
            },
            {
                text: "Carta imprevisti: Usa il comando: prendere il treno", weight: 1,
            },
            {
                text: "Carta imprevisti: Ti piace giocare lentamente? Bene! Al tuo prossimo turno tira solo un dado!", weight: 1,
            },
            {
                text: "Carta imprevisti: Sei stato querelato per aver riso alle battute su Totti! Mo devi annà ar tribunale, devi pagà 'na murta de 150000 sordi e hai da finì ar gabbio!", weight: 1,
                effect: () => {
                    updateBalance(activeActor, -150000);
                }
            },
            {
                text: "Carta imprevisti: Vuoi costruire un computer ma le RAM costano troppo! Paga 600000!", weight: 1,
                effect: () => {
                    updateBalance(activeActor, -600000);
                }
            },
            {
                text: "Carta imprevisti: Scegli una proprietà da mettere all'asta! Puoi tirarti indietro solo se non ce ne sono più di disponibili! Come incentivo ricevi 750000!", weight: 1,
                effect: () => {
                    updateBalance(activeActor, 750000);
                }
            },
            {
                text: "Carta imprevisti: Ti hanno affidato l'incarico di manager per una ditta di demolizioni. Scegli una proprietà non tua su cui puoi far demolire un edificio, dopodichè i soldi che il giocatore prenderà dalla vendita dell'edificio spetteranno a te!", weight: 1,
            },
            {
                text: "Carta imprevisti: tutti gli altri giocatori devono dire: carta imprevisti!", weight: 1,
            },
            {
                text: "Carta imprevisti: Vai fino a via Accademia, fammi sapere se passi dal via!", weight: 1,
            },
            {
                text: "Carta imprevisti: Vai fino al parco della vittoria!", weight: 1,
            },
            {
                text: "Carta imprevisti: Vai fino alla società più vicina! Fammi sapere se passi dal via! Se appartiene a qualcun altro, paga 10000 volte il valore dei dadi!", weight: 1,
            },
            {
                text: "Carta imprevisti: Vai fino alla stazione più vicina! Fammi sapere se passi dal via! Se appartiene a qualcun altro, paga il doppio dell'affitto!", weight: 1,
            },
            {
                text: "Carta imprevisti: Sei diventato molto popolare, il sindaco ti ha dato una carta esci gratis di prigione! Tienila per il futuro o scambiala con qualcuno!", weight: 1,
            },
            {
                text: "Carta imprevisti: Mi piace il tuo stile! prendi una carta esci gratis di prigione! Tienila per il futuro o scambiala con qualcuno!", weight: 1,
            },
            {
                text: "Carta imprevisti: Hai usato un'app per usare il Monopoly senza licenza di Hasbro? Vai dritto in prigione senza passare dal Via!", weight: 1,
            },
            {
                text: "Carta imprevisti: Mi hai insultato su Monopoly Voice Banking? Vai dritto in prigione e vergognati!", weight: 1,
            },
            {
                text: "Carta imprevisti: Riendiamo il gioco più divertente! Nel tuo prossimo turno tira 3 dadi.", weight: 1,
            },
            {
                text: "Carta imprevisti: Buon compleanno! Ricevete 250000 da ogni giocatore.", weight: 1,
                effect: () => {
                    const otherPlayers = selectedColors.filter(c =>
                        c !== activeActor && !gameState.bankruptPlayers.includes(c)
                    );
                    let totalReceived = 0;
                    for (const player of otherPlayers) {
                        const amount = Math.min(250000, gameState.players[player].balance);
                        updateBalance(player, -amount);
                        totalReceived += amount;
                    }
                    updateBalance(activeActor, totalReceived);
                }
            },
            {
                text: "Carta imprevisti: È arrivato il rimborso delle tasse: incassa 500000.", weight: 1,
                effect: () => {
                    updateBalance(activeActor, 500000);
                }
            },
            {
                text: "Carta imprevisti: Scade l'assicurazione sulla vita: incassa 1000000.", weight: 1,
                effect: () => {
                    updateBalance(activeActor, 1000000);
                }
            },
            {
                text: "Carta imprevisti: Sembra tu abbia mal di gola, ti ho fissato un appuntamento dal dottore, purtroppo la sanità pubblica non vi accetta prima del 2054, pagate 1000000.", weight: 1,
                effect: () => {
                    updateBalance(activeActor, -1000000);
                }
            },
            {
                text: "Carta imprevisti: Avete fatto il corso per ambienti in spazi confinati? Tutti gli imprenditori l'hanno fatto! Come potresti vivere senza! paghi 1500000 per l'iscrizione.", weight: 1,
                effect: () => {

                    updateBalance(activeActor, -1500000);
                }
            },
            {
                text: "Carta imprevisti: Dovresti farti doppiare da un altro giocatore, pago ogni giocatore 250000", weight: 1,
                effect: () => {
                    const recipients = selectedColors.filter(c =>
                        c !== activeActor && !gameState.bankruptPlayers.includes(c)
                    );
                    const totalRequired = recipients.length * 250000;
                    for (const recipient of recipients) {
                        updateBalance(activeActor, -250000);
                        updateBalance(recipient, 250000);
                    }
                }
            },
            {
                text: "Carta imprevisti: Ricevete una consulenza: incassi 500000.", weight: 1,
                effect: () => {
                    updateBalance(activeActor, 500000);
                }
            },
            {
                text: "Carta imprevisti: Hai pagato il notaio per gli edifici costruiti? pagate subito 500000 per ogni casa e 1000000 per ogni albergo.", weight: 1,
                effect: () => {
                    const { houses, hotels } = countPlayerBuildings(activeActor);
                    const total = houses * 500000 + hotels * 1000000;
                    updateBalance(activeActor, -total);
                }
            },
            {
                text: "Carta imprevisti: Gli edifici costruiti sono troppo lontani da una fognatura, bisogna costruire un depuratore con lo scarico al suolo, per fortuna c'è lo sconto ambientale! Il prezzo è di 150000 per ogni casa e 300000 per ogni albergo.", weight: 1,
                effect: () => {
                    const { houses, hotels } = countPlayerBuildings(activeActor);
                    const total = houses * 150000 + hotels * 300000;
                    updateBalance(activeActor, -total);
                }
            },
            {
                text: "Carta imprevisti: Hai vinto un premio di bellezza: incassi 100000.", weight: 1,
                effect: () => {
                    updateBalance(activeActor, 100000);
                }
            },
            {
                text: "Carta imprevisti: Erediti 1000000.", weight: 1,
                effect: () => {
                    updateBalance(activeActor, 1000000);
                }
            },
            // --- NUOVE CARTE IMPREVISTI DIVERTENTI E BILANCIATE ---
            {
                text: "Carta imprevisti: Hai vinto la lotteria nazionale! Incassi 3000000.", weight: 1,
                effect: () => {
                    updateBalance(activeActor, 3000000);
                }
            },
            {
                text: "Carta imprevisti: Hai dato da mangiare al gatto? Vai a farlo subito! Salta il tuo prossimo turno.", weight: 1,
            },
            {
                text: "Carta imprevisti: Hai già dato da mangiare al gatto? Bene! Ritira i dadi.", weight: 1,
            },
            {
                text: "Carta imprevisti: Un giocatore ti querela per calunnia, scegli un giocatore a cui dare 500000 usando il comando: paga.", weight: 1,
            },
            {
                text: "Carta imprevisti: Hai partecipato alla ruota della fortuna e Gerry Scotti ti ha donato 800000.", weight: 1,
                effect: () => {
                    updateBalance(activeActor, 800000);
                }
            },
            {
                text: "Carta imprevisti: Il tuo computer è stato infettato da un virus, devi pagare il pizzo, anche chiamato antivirus costa 750000.", weight: 1,
                effect: () => {
                    updateBalance(activeActor, -750000);
                }
            },
            {
                text: "Carta imprevisti: Sei stato eletto sindaco per un giorno! Ogni giocatore ti paga 100000.", weight: 1,
                effect: () => {
                    const otherPlayers = selectedColors.filter(c =>
                        c !== activeActor && !gameState.bankruptPlayers.includes(c)
                    );
                    let totalReceived = 0;
                    for (const player of otherPlayers) {
                        const amount = Math.min(100000, gameState.players[player].balance);
                        updateBalance(player, -amount);
                        totalReceived += amount;
                    }
                    updateBalance(activeActor, totalReceived);
                }
            },
            {
                text: "Carta imprevisti: Hai investito in criptovalute e hai perso tutto! Perdi 1500000.", weight: 1,
                effect: () => {
                    if (gameState.players[activeActor].balance < 1500000) {
                        return;
                    }
                    updateBalance(activeActor, -1500000);
                }
            }
        ];


        function drawImprevisto() {
            if (!activeActor) return;

            let totalWeight = imprevisti.reduce((sum, card) => sum + (card.weight || 1), 0);
            let random = Math.random() * totalWeight;
            let currentSum = 0;
            let cardIndex = 0;

            for (let i = 0; i < imprevisti.length; i++) {
                currentSum += (imprevisti[i].weight || 1);
                if (random <= currentSum) {
                    cardIndex = i;
                    break;
                }
            }

            const card = imprevisti[cardIndex];
            card.weight = 0.25;

            let finalText = card.text;
            if (card.text === "VAI_A_PROPRIETA_CASUALE") {
                finalText = `Carta imprevisti: Vai fino a ${getRandomProperty()}, fammi sapere se passi dal via!`;
            }

            const ancoraNuove = imprevisti.filter(c => c.weight === 1);
            if (ancoraNuove.length === 0) {
                imprevisti.forEach(c => c.weight = 1);
            }

            const t = finalText.toLowerCase();
            const isPositive = t.includes("incass") || t.includes("ritir") || t.includes("ricev") || t.includes("vinc") || t.includes("eredit");

            speak(finalText, isPositive ? "Ka-ching" : null, true);
            setTimeout(() => { if (card.effect) card.effect(); }, 100);
        }


        // VARIABILI GLOBALI PER IL FUNZIONAMENTO
        let selectedColors = []; // Giocatori scelti nel setup
        let activeActor = null; // Il giocatore che ha premuto il pulsante e sta parlando
        let recognition; // L'oggetto per il riconoscimento vocale
        let isListening = false; // Stato del microfono
        let tapCount = 0; // Contatore per i 3 tocchi segreti
        let tapTimer;

        // PRE-CARICAMENTO AUDIO
        let audioFiles = {};
        const audioMap = {
            'ping': 'ping.mp3',
            'Ka-ching': 'Ka-ching.mp3',
            'train': 'train.mp3',
            'martelletto': 'martelletto.mp3',
            'build': 'build.mp3',
            'gameover': 'gameover.mp3',
            'victory': 'victory.mp3'
        };

        function preloadAudios() {
            for (let key in audioMap) {
                audioFiles[key] = new Audio(audioMap[key]);
                audioFiles[key].load();
            }
        }

        // NUOVA FUNZIONE SPEAK
        function speak(text, soundFile = null, soundAfter = false, delay = 0) {
            window.speechSynthesis.cancel();
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'it-IT';

            if (soundFile && !soundAfter) {
                // Suono PRIMA → attesa → testo vocale
                const audio = new Audio(soundFile + '.mp3');
                audio.play().catch(e => { });

                if (delay > 0) {
                    setTimeout(() => {
                        window.speechSynthesis.speak(utter);
                    }, delay);
                } else {
                    window.speechSynthesis.speak(utter);
                }
            } else if (soundFile && soundAfter) {
                // Testo vocale → attesa → suono DOPO
                utter.onend = () => {
                    if (delay > 0) {
                        setTimeout(() => {
                            const audio = new Audio(soundFile + '.mp3');
                            audio.play().catch(e => { });
                        }, delay);
                    } else {
                        const audio = new Audio(soundFile + '.mp3');
                        audio.play().catch(e => { });
                    }
                };
                window.speechSynthesis.speak(utter);
            } else {
                // Solo testo vocale
                window.speechSynthesis.speak(utter);
            }
        }

        // INIZIALIZZAZIONE DEL MICROFONO
        function initRecognition() {
            const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!Speech) return;
            recognition = new Speech();
            recognition.lang = 'it-IT';

            recognition.onstart = () => { isListening = true; };

            recognition.onresult = (e) => {
                // Prende il testo capito dal microfono
                const cmd = e.results[0][0].transcript.toLowerCase();
                document.getElementById('transcript').textContent = cmd; // Lo scrive a schermo
                processCommand(cmd); // Invia il testo alla logica del gioco
            };

            // Quando il microfono si spegne, resetta l'interfaccia dopo un secondo
            recognition.onend = () => {
                isListening = false;
                setTimeout(() => { if (!isListening) resetUI(); }, 1200);
            };
        }

        // RESETTA LA GRAFICA (Pulsanti tornano a posto, luci spente)
        function resetUI() {
            document.getElementById('unit').className = 'banker-unit';
            document.querySelectorAll('.player-btn').forEach(b => b.classList.remove('active-focus'));
            document.getElementById('status-text').textContent = "Pronto";
            activeActor = null;
        }

        // GESTORE DEI 3 TOCCHI AL CENTRO (Apre la console manuale)
        document.getElementById('unit').addEventListener('click', function () {
            tapCount++;
            clearTimeout(tapTimer);
            if (tapCount === 3) {
                const consoleDiv = document.getElementById('debug-console');
                consoleDiv.style.display = (consoleDiv.style.display === 'flex') ? 'none' : 'flex';
                tapCount = 0;
            } else { tapTimer = setTimeout(() => { tapCount = 0; }, 500); }
        });

        // AVVIA LA PARTITA
        function startGame() {
            if (selectedColors.length < 2) return alert("Scegli i giocatori!");
            initRecognition();
            preloadAudios();

            // Crea il portafoglio per ogni giocatore scelto
            selectedColors.forEach(color => {
                gameState.players[color] = { balance: 15000000 }; // 15 Milioni iniziali
                document.getElementById(`card-${color}`).classList.add('active');
            });

            // Nasconde i pulsanti dei giocatori non scelti
            ['blu', 'giallo', 'rosso', 'verde'].forEach(c => {
                if (!selectedColors.includes(c)) document.getElementById(`btn-${c}`).style.display = 'none';
            });

            document.getElementById('setup-overlay').style.display = 'none';
            speak("Bene, giochiamo!");
        }

        // ATTIVA IL MICROFONO PER UN GIOCATORE SPECIFICO
        function activate(color) {
            // --- AGGIUNTA: Riproduzione suono ping.mp3 ---
            const audio = new Audio('ping.mp3');
            audio.play().catch(error => console.log("Impossibile riprodurre l'audio:", error));
            // --------------------------------------------

            // Controllo: giocatore in bancarotta non può attivarsi
            if (gameState.bankruptPlayers.includes(color)) {
                speak(`Il giocatore ${color} è in bancarotta.`);
                speak("gameover", true);
                return;
            }

            if (isListening) return;
            activeActor = color;
            document.getElementById(`btn-${color}`).classList.add('active-focus'); // Muove il pulsante
            document.getElementById('unit').className = `banker-unit listening-${color}`; // Accende la luce
            document.getElementById('status-text').textContent = "Ti ascolto...";
            try { recognition.start(); } catch (e) { }
        }

        // CONTROLLA SE UN GIOCATORE POSSIEDE TUTTE LE PROPRIETÀ DI UN COLORE E NESSUNA È IPOTECATA
        function hasFullSet(owner, setName) {
            const setProps = Object.values(gameState.properties).filter(p => p.set === setName);
            // La serie è considerata "completa" solo se il proprietario le ha tutte 
            // E nessuna di esse è ipotecata
            return setProps.every(p => p.owner === owner && !p.mortgaged);
        }

        // CONTA EDIFICI DI UN GIOCATORE (case e alberghi)
        function countPlayerBuildings(player) {
            let houses = 0;
            let hotels = 0;
            for (const prop of Object.values(gameState.properties)) {
                if (prop.owner === player) {
                    if (prop.houses === 5) hotels++;
                    else if (prop.houses > 0) houses += prop.houses;
                }
            }
            return { houses, hotels };
        }

        // CONTA PROPRIETÀ DI UN GIOCATORE (escludendo stazioni e società)
        function countPlayerProperties(player) {
            return Object.values(gameState.properties).filter(prop =>
                prop.owner === player &&
                prop.set !== "stazione" &&
                prop.set !== "società"
            ).length;
        }

        // SELEZIONA UNA PROPRIETÀ CASUALE (escludendo stazioni e società)
        function getRandomProperty() {
            // Filtra proprietà escludendo stazioni e società
            const eligibleProps = Object.entries(gameState.properties).filter(([name, prop]) =>
                prop.set !== "stazione" && prop.set !== "società"
            );

            // Prima cerca proprietà non ancora acquistate
            const freeProps = eligibleProps.filter(([name, prop]) => prop.owner === null);

            // Se ci sono proprietà libere, scegli tra quelle
            if (freeProps.length > 0) {
                const randomIndex = Math.floor(Math.random() * freeProps.length);
                return freeProps[randomIndex][0]; // Restituisce solo il nome
            }

            // Altrimenti scegli casualmente tra tutte le proprietà ammissibili
            const randomIndex = Math.floor(Math.random() * eligibleProps.length);
            return eligibleProps[randomIndex][0]; // Restituisce solo il nome
        }

        // FUNZIONE PESCA AGGIORNATA: SISTEMA AD ESAURIMENTO (0.25 persitente)

        // --- LA LOGICA CENTRALE: COSA FARE QUANDO L'UTENTE PARLA ---
        function processCommand(msg) {

            // COMANDO: PASSA DAL VIA
            if (msg.includes("pass") && msg.includes("via")) {
                updateBalance(activeActor, 2000000);
                speak(`Ecco a te 2000000!`, "Ka-ching", true, 500);
                return;
            }

            // COMANDO: PRENDERE IL TRENO
            if (msg.includes("treno")) {

                speak(`In carrozza! Vai fino a ${getRandomProperty()}.`, "train", false, 3000);
                return;
            }

            // COMANDO: PESCA IMPREVISTO
            if (msg.includes("imprevist") || msg.includes("probabilità")) {
                drawImprevisto();
                return;
            }

            // COMANDO: IMPOSTA I SOLDI
            if (msg.includes("imposta") && msg.includes("soldi") || msg.includes("denaro")) {
                const amount = parseMoney(msg);
                if (amount <= 0) {
                    speak("Importo non valido. Specifica un valore positivo.");
                    return;
                }
                const oldBalance = gameState.players[activeActor].balance;
                gameState.players[activeActor].balance = amount;
                document.getElementById(`bal-${activeActor}`).textContent = formatMoney(amount);
                speak(`Ho impostato ${formatMoneyForSpeech(amount)} a ${activeActor} banconote del monopoly.`);
                return;
            }

            // COMANDO: ESCI DALLA PRIGIONE
            if ((msg.includes("esci") && msg.includes("prigione")) || msg.includes("prigione")) {
                const jailFee = 500000;
                if (gameState.players[activeActor].balance < jailFee) {
                    speak(`Denaro insufficiente per pagare ${formatMoneyForSpeech(jailFee)}.`);
                    return;
                }
                updateBalance(activeActor, -jailFee);
                speak(`Hai pagato ${formatMoneyForSpeech(jailFee)}, puoi uscire di prigione, lancia i dadi!`);
                return;
            }

            // COMANDO: ACQUISTA UNA PROPRIETÀ
            if (msg.includes("acquista") || msg.includes("compra")) {
                for (let p in gameState.properties) {
                    if (msg.includes(p)) {
                        let prop = gameState.properties[p];
                        if (prop.owner) return speak(`${prop.owner} possiede ${p}.`);
                        if (gameState.players[activeActor].balance >= prop.price) {
                            updateBalance(activeActor, -prop.price);
                            prop.owner = activeActor;
                            speak(`${p}, è tua per ${formatMoneyForSpeech(prop.price)} banconote del monopoly!`, "Ka-ching", false, 2000);
                        } else { speak("Non hai abbastanza denaro."); }
                        return;
                    }
                }
            }

            // --- NUOVI COMANDI: GESTIONE PROPRIETÀ SENZA TRANSAZIONI ---

            // COMANDO: OTTIENI PROPRIETÀ (con eventuale pagamento)
            if (msg.includes("ottieni")) {
                for (let p in gameState.properties) {
                    if (msg.includes(p)) {
                        let prop = gameState.properties[p];
                        if (prop.owner) return speak(`${prop.owner} possiede ${p}!`);

                        let cost = parseMoney(msg); // Cerca una cifra nel comando

                        if (cost > 0) {
                            // Messaggio se è stata specificata una cifra
                            if (gameState.players[activeActor].balance >= cost) {
                                updateBalance(activeActor, -cost);
                                prop.owner = activeActor;
                                speak(`${p} è tua per ${formatMoneyForSpeech(cost)} banconote del monopoly!`);
                            } else {
                                speak("Non hai abbastanza denaro per questa cifra.");
                            }
                        } else {
                            // Messaggio se la cifra è 0 o non specificata
                            prop.owner = activeActor;
                            speak(`${p} ora è tua!`);
                        }
                        return;
                    }
                }
                speak("Proprietà non trovata.");
                return;
            }
            // COMANDO: PERDI PROPRIETÀ (senza nulla in cambio)
            if (msg.includes("perdi")) {
                for (let p in gameState.properties) {
                    if (msg.includes(p)) {
                        let prop = gameState.properties[p];
                        if (prop.owner !== activeActor) return speak("Non possiedi questa proprietà.");

                        prop.owner = null;
                        prop.houses = 0; // Resetta anche gli edifici
                        prop.mortgaged = false; // Resetta ipoteca
                        speak(`Hai perso ${p}.`);
                        return;
                    }
                }
                speak("Proprietà non trovata.");
                return;
            }

            // COMANDO: CEDI PROPRIETÀ (trasferimento gratuito ad altro giocatore)
            if (msg.includes("cedi")) {
                for (let p in gameState.properties) {
                    if (msg.includes(p)) {
                        let prop = gameState.properties[p];
                        if (prop.owner !== activeActor) return speak(`${prop.owner} possiede ${p}`);

                        // Trova il destinatario (altro giocatore attivo)
                        const possibleRecipients = selectedColors.filter(color =>
                            color !== activeActor && !gameState.bankruptPlayers.includes(color) && msg.includes(color)
                        );

                        if (possibleRecipients.length === 0) {
                            speak("Destinatario non specificato o non valido.");
                            return;
                        }

                        const recipient = possibleRecipients[0];
                        prop.owner = recipient;
                        speak(`Ora ${p} appartiene a ${recipient}.`);
                        return;
                    }
                }
                speak("Proprietà non trovata.");
                return;
            }

            // --- COMANDO: BANCAROTTA ---
            if (msg.includes("bancarotta")) {
                const player = activeActor;

                // Piccolo ritardo per dare tempo di ascoltare
                setTimeout(() => {
                    // 1. Azzera il saldo
                    gameState.players[player].balance = 0;
                    document.getElementById(`bal-${player}`).textContent = "0";

                    // 2. Rimuovi tutte le proprietà del giocatore
                    for (let p in gameState.properties) {
                        let prop = gameState.properties[p];
                        if (prop.owner === player) {
                            prop.owner = null;
                            prop.houses = 0;
                            prop.mortgaged = false;
                        }
                    }

                    // 3. Aggiungi alla lista dei falliti
                    gameState.bankruptPlayers.push(player);

                    // 4. Rimuovi dalla lista dei giocatori attivi
                    selectedColors = selectedColors.filter(c => c !== player);

                    // 5. Nascondi la balance-card e applica stile bancarotta
                    const card = document.getElementById(`card-${player}`);
                    card.classList.remove('active');
                    card.classList.add('bancarotta');

                    // 6. Nascondi il pulsante del giocatore
                    document.getElementById(`btn-${player}`).style.display = 'none';

                    // 7. Resetta l'interfaccia
                    resetUI();

                    // 8. Feedback vocale

                    speak(`Giocatore ${player} è andato in bancarotta. Tutte le sue proprietà ora appartengono alla banca.`, "gameover", true);

                    // 9. Controlla se rimane un solo giocatore (vincitore)
                    const remainingPlayers = selectedColors.filter(c => !gameState.bankruptPlayers.includes(c));
                    if (remainingPlayers.length === 1) {
                        setTimeout(() => {
                            speak(`Il vincitore è il giocatore ${remainingPlayers[0]}! Congratulazioni!`, "victory", true);
                        }, 12000);
                    }
                }, 1500);

                return;
            }

            // COMANDO: PAGA L'AFFITTO
            if (msg.includes("affitto")) {
                for (let p in gameState.properties) {
                    if (msg.includes(p)) {
                        let prop = gameState.properties[p];
                        if (!prop.owner || prop.owner === activeActor) return speak("Nessun affitto dovuto.");
                        if (prop.mortgaged) return speak("La proprietà è ipotecata.");

                        // Società (non hanno affitto automatico qui)
                        if (prop.set === "società") return speak(`Lancia i dadi per calcolare l'affitto, dopodiché usa il comando paga il giocatore ${prop.owner}.`);

                        let amount = 0;
                        // Caso: Stazioni
                        if (prop.set === "stazione") {
                            // Conta quante stazioni possiede il proprietario (escludendo le ipotecate)
                            const activeStations = Object.values(gameState.properties).filter(s =>
                                s.set === "stazione" && s.owner === prop.owner && !s.mortgaged
                            ).length;
                            const stationRents = { 1: 250000, 2: 500000, 3: 1000000, 4: 2000000 };
                            amount = stationRents[activeStations];
                        }
                        // Caso: Proprietà colorate
                        else {
                            if (prop.houses > 0) {
                                // Se ci sono case, prendi l'affitto corrispondente dal database
                                amount = prop.rents[prop.houses];
                            } else {
                                // Se non ci sono case, affitto base o doppio se ha la serie completa
                                amount = prop.rents[0];
                                if (hasFullSet(prop.owner, prop.set)) amount *= 2;
                            }
                        }

                        updateBalance(activeActor, -amount);
                        updateBalance(prop.owner, amount);
                        speak(`Hai pagato al giocatore ${prop.owner}, ${formatMoneyForSpeech(amount)} banconote del monopoly.`, "Ka-ching", false, 2000);
                        return;
                    }
                }
            }

            // PAGA UN ALTRO GIOCATORE
            // Trigger words: paga, versa, dai + nome colore (escluso se stesso) + importo
            // Evita conflitti con "affitto" e comandi esistenti
            if ((msg.includes("paga") || msg.includes("versa") || msg.includes("dai")) && !msg.includes("affitto")) {
                // Trova possibili destinatari (giocatori attivi diversi da chi parla)
                const possibleRecipients = selectedColors.filter(color =>
                    color !== activeActor && !gameState.bankruptPlayers.includes(color) && msg.includes(color)
                );

                if (possibleRecipients.length > 0) {
                    // Prende il primo destinatario trovato (ordine selezione)
                    const recipient = possibleRecipients[0];
                    const amount = parseMoney(msg);

                    // Validazione importo
                    if (amount <= 0) {
                        speak("Importo non riconosciuto. Specifica una somma valida.");
                        return;
                    }

                    // Validazione saldo
                    if (gameState.players[activeActor].balance < amount) {
                        speak("Non hai abbastanza denaro.");
                        return;
                    }

                    // Esecuzione transazione
                    updateBalance(activeActor, -amount);
                    updateBalance(recipient, amount);
                    speak(`Hai pagato ${formatMoneyForSpeech(amount)} banconote del monopoly a ${recipient}.`);
                    return; // Esci dopo aver gestito il comando
                }
            }

            if (msg.includes("asta")) {
                let propName = null;
                for (let p in gameState.properties) { if (msg.includes(p)) { propName = p; break; } }

                if (propName) {
                    speak(`Asta per ${propName}! I giocatori possono rilanciare a voce. Al termine, il vincitore deve dire: Ottieni ${propName}, seguito dalla cifra finale.`, "martelletto", false, 2000);
                } else {
                    speak("Quale proprietà vuoi mettere all'asta?");
                }
                return;
            }

            // --- LOGICA COSTRUZIONE AVANZATA (CASE E ALBERGHI) ---
            const isBuilding = msg.includes("costrui") || msg.includes("metti") || msg.includes("compra") || msg.includes("fai");
            const colorSets = ["marrone", "azzurro", "rosa", "arancio", "rosso", "giallo", "verde", "blu"];

            // 1. GESTIONE COSTRUZIONE CASE
            if (isBuilding && (msg.includes("casa") || msg.includes("abitazione"))) {
                let targetSet = colorSets.find(c => msg.includes(c));

                // Caso A: Costruzione su intera SERIE (Colore)
                if (targetSet) {
                    let propsInSet = Object.entries(gameState.properties).filter(([name, p]) => p.set === targetSet);
                    let missing = propsInSet.filter(([name, p]) => p.owner !== activeActor).map(([name, p]) => name);

                    if (missing.length > 0) {
                        speak(`Non puoi costruire. Per la serie ${targetSet} ti mancano: ${missing.join(", ")}.`);
                        return;
                    }

                    let builtOn = [];
                    let totalCost = 0;

                    propsInSet.forEach(([name, prop]) => {
                        if (prop.houses < 4) {
                            if (gameState.players[activeActor].balance >= (totalCost + prop.buildCost)) {
                                prop.houses++;
                                totalCost += prop.buildCost;
                                builtOn.push(name);
                            }
                        }
                    });

                    if (builtOn.length > 0) {
                        updateBalance(activeActor, -totalCost);
                        speak(`Metti una casa su ${builtOn.join(", ")}. Costo totale: ${formatMoneyForSpeech(totalCost)} banconote del monopoly.`, "build", false, 3000);
                    } else {
                        speak(`Tutte le proprietà ${targetSet} hanno già 4 case o non hai abbastanza denaro.`);
                    }
                    return;
                }

                // Caso B: Costruzione su SINGOLA proprietà
                for (let p in gameState.properties) {
                    if (msg.includes(p)) {
                        let prop = gameState.properties[p];
                        if (prop.set === "stazione" || prop.set === "società") return speak("Non si può costruire qui.");
                        if (prop.owner !== activeActor) return speak(`Non possiedi ${p}, appartiene al giocatore ${prop.owner}.`);

                        if (!hasFullSet(activeActor, prop.set)) {
                            let missing = Object.entries(gameState.properties)
                                .filter(([name, pt]) => pt.set === prop.set && pt.owner !== activeActor)
                                .map(([name, pt]) => name);
                            speak(`Ti manca ${missing.join(", ")} per completare la serie ${prop.set}.`);
                            return;
                        }

                        if (prop.houses >= 4) return speak(`Su ${p} ci sono già 4 case. Di' "costruire un albergo" per procedere.`);

                        if (gameState.players[activeActor].balance >= prop.buildCost) {
                            updateBalance(activeActor, -prop.buildCost);
                            prop.houses++;
                            speak(`Metti una casa su ${p}.`, "build", false, 3000);
                        } else {
                            speak(`Ti servono ${formatMoneyForSpeech(prop.buildCost)} per una mettere casa qui.`);
                        }
                        return;
                    }
                }
            }

            // 2. GESTIONE COSTRUZIONE ALBERGHI (Con acquisto automatico case mancanti)
            if (isBuilding && (msg.includes("albergo") || msg.includes("hotel"))) {
                let targetSet = colorSets.find(c => msg.includes(c));

                // Caso A: Alberghi su intera SERIE (Colore)
                if (targetSet) {
                    let propsInSet = Object.entries(gameState.properties).filter(([name, p]) => p.set === targetSet);
                    let missing = propsInSet.filter(([name, p]) => p.owner !== activeActor).map(([name, p]) => name);

                    if (missing.length > 0) {
                        speak(`Non puoi costruire. Per la serie ${targetSet} ti mancano: ${missing.join(", ")}.`);
                        return;
                    }

                    let builtOn = [];
                    let totalCost = 0;

                    propsInSet.forEach(([name, prop]) => {
                        if (prop.houses < 5) {
                            let housesToBuy = 5 - prop.houses;
                            let cost = housesToBuy * prop.buildCost;

                            if (gameState.players[activeActor].balance >= (totalCost + cost)) {
                                prop.houses = 5;
                                totalCost += cost;
                                builtOn.push(name);
                            }
                        }
                    });

                    if (builtOn.length > 0) {
                        updateBalance(activeActor, -totalCost);
                        speak(`Metti gli hotel su: ${builtOn.join(", ")}. Ho incluso il costo delle case mancanti per arrivare all'hotel. Totale: ${formatMoneyForSpeech(totalCost)} banconote.`, "build", false, 3000);
                    } else {
                        speak(`Non hai abbastanza denaro o hai già tutti gli hotel sulla serie ${targetSet}.`);
                    }
                    return;
                }

                // Caso B: Albergo su SINGOLA proprietà
                for (let p in gameState.properties) {
                    if (msg.includes(p)) {
                        let prop = gameState.properties[p];
                        if (prop.owner !== activeActor) return speak(`${p} non è tua.`);
                        if (!hasFullSet(activeActor, prop.set)) return speak("Devi avere la serie completa.");
                        if (prop.houses === 5) return speak(`C'è già un hotel su ${p}.`);

                        let housesToBuy = 5 - prop.houses;
                        let totalCost = housesToBuy * prop.buildCost;

                        if (gameState.players[activeActor].balance >= totalCost) {
                            updateBalance(activeActor, -totalCost);
                            prop.houses = 5;
                            let text = housesToBuy > 1 ? `Ho aggiunto le case mancanti e l'hotel su ${p}.` : `Hotel costruito su ${p}.`;
                            speak(`${text} Spesa totale: ${formatMoneyForSpeech(totalCost)}.`, "build", false, 3000);
                        } else {
                            speak(`Ti mancano i fondi: l'operazione costa ${formatMoneyForSpeech(totalCost)}.`);
                        }
                        return;
                    }
                }
            }
            // COMANDO: DEMOLIZIONE (Vendere edifici per metà prezzo)
            const isDemolishing = msg.includes("vendi") || msg.includes("togli") || msg.includes("demolisci") || msg.includes("rimuovi");
            if (isDemolishing && (msg.includes("casa") || msg.includes("albergo") || msg.includes("hotel"))) {
                for (let p in gameState.properties) {
                    if (msg.includes(p)) {
                        let prop = gameState.properties[p];
                        if (prop.owner !== activeActor) return speak(`${prop.owner} possiede ${p}`);
                        if (!prop.houses || prop.houses === 0) return speak("Non ci sono edifici.");

                        let refund = prop.buildCost / 2; // Recuperi il 50%
                        if (prop.houses === 5) {
                            prop.houses = 4; // Rimuovendo l'hotel torni a 4 case
                            speak(`Hotel rimosso. Tornano 4 case.`);
                        } else {
                            prop.houses--;
                            speak(`Casa venduta su ${p}.`);
                        }
                        updateBalance(activeActor, refund);
                        speak(`Ricevuti ${formatMoneyForSpeech(refund)}.`);
                        return;
                    }
                }
            }

            // COMANDO: IPOTECA (Prendi metà valore della proprietà)
            if (msg.includes("ipoteca") && !msg.includes("togli") && !msg.includes("rimuovi") && !msg.includes("ripaga") && !msg.includes("cancella")) {
                for (let p in gameState.properties) {
                    if (msg.includes(p)) {
                        let prop = gameState.properties[p];

                        // Controllo proprietà
                        if (prop.owner !== activeActor) return speak(`Non è tua, appartiene a ${prop.owner}`);

                        // NUOVO: Controllo se è già ipotecata
                        if (prop.mortgaged) return speak("Questa proprietà è già ipotecata.");

                        // NUOVO: Controllo edifici in tutta la serie (set)
                        const buildingsInSet = Object.values(gameState.properties).some(item =>
                            item.set === prop.set && item.houses > 0
                        );
                        if (buildingsInSet) return speak("devi prima demolire tutti gli edifici dalla serie di proprietà");

                        // Esecuzione ipoteca
                        prop.mortgaged = true;
                        let val = prop.price / 2;
                        updateBalance(activeActor, val);
                        speak(`${p} ipotecata. Ricevi ${formatMoneyForSpeech(val)} banconote del monopoly.`);
                        return;
                    }
                }
            }

            // COMANDO: TOGLI IPOTECA (Paghi metà valore + 10%)
            if (msg.includes("togli") || msg.includes("cancella") || msg.includes("rimuovi") || msg.includes("ripaga") && msg.includes("ipoteca")) {
                for (let p in gameState.properties) {
                    if (msg.includes(p)) {
                        let prop = gameState.properties[p];
                        if (!prop.mortgaged) return speak("Non è ipotecata.");
                        let val = Math.round(prop.price * 0.55);
                        if (gameState.players[activeActor].balance >= val) {
                            updateBalance(activeActor, -val);
                            prop.mortgaged = false;
                            speak(`Ipoteca tolta da ${p} pagando ${formatMoneyForSpeech(val)} banconote del monopoly.`);
                        } else { speak("Non hai abbastanza denaro."); }
                        return;
                    }
                }
            }


            // COMANDI GENERICI: PAGA O INCASSA DALLA BANCA
            if (msg.includes("paga") || msg.includes("versa") || msg.includes("togli")) {
                let amt = parseMoney(msg);
                if (amt > 0) {
                    if (gameState.players[activeActor].balance < amt) {
                        speak("Non hai abbastanza denaro.");
                        return;
                    }
                    updateBalance(activeActor, -amt);
                    speak(`Pagati ${formatMoneyForSpeech(amt)}.`);
                }
                return;
            }

            if (msg.includes("incassa") || msg.includes("ricevi") || msg.includes("aggiungi")) {
                let amt = parseMoney(msg);
                if (amt > 0) {
                    updateBalance(activeActor, amt);
                    speak(`Ricevuti ${formatMoneyForSpeech(amt)} banconote del monopoly.`, "Ka-ching", true, 100);
                }
                return;
            }

            // Se non ha trovato nessun comando valido
            speak("Non ho capito il comando.");
        }

        // AGGIORNA IL SALDO DI UN GIOCATORE E LO SCRIVE NELLA CARD
        function updateBalance(player, amount) {
            // Controllo: giocatore in bancarotta non può ricevere/transare
            if (gameState.bankruptPlayers.includes(player)) return;

            gameState.players[player].balance += amount;
            document.getElementById(`bal-${player}`).textContent = formatMoney(gameState.players[player].balance);
        }

        // TRASFORMA I NUMERI IN TESTO LEGGIBILE (es: 1500000 -> "1.5 milioni") - PER VISUALIZZAZIONE
        function formatMoney(n) {
            if (n >= 1000000) {
                let val = (n / 1000000).toFixed(1);
                val = val.endsWith(".0") ? val.slice(0, -2) : val; // Toglie lo .0 inutile
                return val + (val === "1" ? " milione" : " milioni");
            }
            if (n >= 1000) return (n / 1000) + " mila";
            return n;
        }

        // TRASFORMA I NUMERI IN TESTO PER LA SINTESI VOCALE (solo numeri interi)
        function formatMoneyForSpeech(n) {
            return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        // TRASFORMA LE PAROLE CAPITE DAL MICROFONO IN NUMERI (Supporta somme composte come 1 milione e 500 mila)
        function parseMoney(text) {
            // 1. Pulizia: rimuove i punti che il microfono mette a volte come separatori delle migliaia
            text = text.replace(/\./g, "").toLowerCase();

            // 2. Database delle somme scritte in lettere (da 50k a 950k)
            const paroleComposte = {
                "cinquantamila": 50000, "centomila": 100000, "centocinquantamila": 150000,
                "duecentomila": 200000, "duecentocinquantamila": 250000, "trecentomila": 300000,
                "trecentocinquantamila": 350000, "quattrocentomila": 400000, "quattrocentocinquantamila": 450000,
                "cinquecentomila": 500000, "cinquecentocinquantamila": 550000, "seicentomila": 600000,
                "seicentocinquantamila": 650000, "settecentomila": 700000, "settecentocinquantamila": 750000,
                "ottocentomila": 800000, "ottocentocinquantamila": 850000, "novecentomila": 900000,
                "novecentocinquantamila": 950000
            };

            const paroleSemplici = { "un": 1, "uno": 1, "due": 2, "tre": 3, "quattro": 4, "cinque": 5, "sei": 6, "sette": 7, "otto": 8, "nove": 9, "dieci": 10 };

            function extractValue(subtext) {
                // Cerca prima nei numeri scritti (es: "500000")
                let matchDigit = subtext.match(/\d+/);
                if (matchDigit) return parseInt(matchDigit[0]);
                // Poi nelle parole semplici (es: "cinque")
                for (let parola in paroleSemplici) {
                    if (subtext.includes(parola)) return paroleSemplici[parola];
                }
                return 0;
            }

            let totale = 0;

            // 3. Controllo parole composte (es: "cinquecentomila")
            for (let parola in paroleComposte) {
                if (text.includes(parola)) {
                    totale += paroleComposte[parola];
                    // Rimuove la parola per evitare che venga contata di nuovo nel ciclo successivo
                    text = text.replace(parola, "");
                }
            }

            // 4. Gestione MILIONI + migliaia rimanenti (es: "un milione e 500 mila")
            if (text.includes("milion")) {
                let partiMilioni = text.split(/milion[ei]/);
                totale += extractValue(partiMilioni[0]) * 1000000;

                if (partiMilioni[1] && partiMilioni[1].includes("mila")) {
                    totale += extractValue(partiMilioni[1]) * 1000;
                }
            }
            // 5. Gestione MIGLIAIA semplici (es: "500 mila")
            else if (text.includes("mila")) {
                totale += extractValue(text) * 1000;
            }
            // 6. Cifra secca senza parole chiave (es: "paga 200")
            else {
                let val = extractValue(text);
                if (val > 0) {
                    // Se dici un numero piccolo (es: 100), il banchiere assume "mila"
                    totale += (val < 1000) ? val * 1000 : val;
                }
            }

            return totale;
        }

        // GESTORE SELEZIONE GIOCATORI (Setup)
        function togglePlayer(color, el) {
            if (selectedColors.includes(color)) {
                selectedColors = selectedColors.filter(c => c !== color);
                el.classList.remove('selected');
            } else {
                selectedColors.push(color);
                el.classList.add('selected');
            }
        }

        // INVIA COMANDO DALLA CONSOLE MANUALE
        function sendManualCommand() {
            const input = document.getElementById('debug-input');
            processCommand(input.value.toLowerCase());
            input.value = "";
        }
    </script>
</body>

</html>
